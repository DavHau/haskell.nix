<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Motivation - Alternative Haskell Infrastructure for Nixpkgs</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Motivation";
    var mkdocs_page_input_path = "motivation.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Alternative Haskell Infrastructure for Nixpkgs</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">Introduction</a>
	    </li>
          
            <li class="toctree-l1 current">
		
    <a class="current" href="./">Motivation</a>
    <ul class="subnav">
            
    <li class="toctree-l2"><a href="#motivation">Motivation</a></li>
    
        <ul>
        
            <li><a class="toctree-l3" href="#cross-compilation">Cross compilation</a></li>
        
            <li><a class="toctree-l3" href="#package-sets">Package sets</a></li>
        
            <li><a class="toctree-l3" href="#per-component-level-control">Per component level control</a></li>
        
            <li><a class="toctree-l3" href="#cyclic-dependencies">Cyclic dependencies</a></li>
        
            <li><a class="toctree-l3" href="#build-times">Build times</a></li>
        
            <li><a class="toctree-l3" href="#more-logic-in-nix">More logic in nix</a></li>
        
            <li><a class="toctree-l3" href="#decoupling">Decoupling</a></li>
        
        </ul>
    

    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../architecture/">Architecture</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Tutorials</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../tutorials/getting-started/">Getting Started</a>
                </li>
                <li class="">
                    
    <a class="" href="../tutorials/getting-started-flakes/">Getting started with Flakes</a>
                </li>
                <li class="">
                    
    <a class="" href="../tutorials/development/">Creating a development environment</a>
                </li>
                <li class="">
                    
    <a class="" href="../tutorials/clean-git/">Sourcing files only part of git repository using cleanGit</a>
                </li>
                <li class="">
                    
    <a class="" href="../tutorials/source-repository-hashes/">Handling git repositories in projects</a>
                </li>
                <li class="">
                    
    <a class="" href="../tutorials/pkg-map/">Mapping non-Haskell dependencies to Nixpkgs</a>
                </li>
                <li class="">
                    
    <a class="" href="../tutorials/hackage-stackage/">Bumping Hackage and Stackage snapshots</a>
                </li>
                <li class="">
                    
    <a class="" href="../tutorials/materialization/">Materialization: Speeding up Nix evaluation</a>
                </li>
                <li class="">
                    
    <a class="" href="../tutorials/cross-compilation/">Cross-compiling your project</a>
                </li>
                <li class="">
                    
    <a class="" href="../tutorials/coverage/">Generating coverage information</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Reference</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../reference/supported-ghc-versions/">Supported GHC versions</a>
                </li>
                <li class="">
                    
    <a class="" href="../reference/commands/">Command-line tools</a>
                </li>
                <li class="">
                    
    <a class="" href="../reference/library/">Haskell.nix Library</a>
                </li>
                <li class="">
                    
    <a class="" href="../reference/modules/">Module options</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../troubleshooting/">Troubleshooting</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Templates / Abstraction</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../iohk-nix/">IOHKs nix library</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Dev Notes</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../dev/dev-architecture/">Architecture</a>
                </li>
                <li class="">
                    
    <a class="" href="../dev/installing-nix-tools/">Installing nix-tools</a>
                </li>
                <li class="">
                    
    <a class="" href="../dev/manually-generating-nix-expressions/">Manually generating Nix expressions</a>
                </li>
                <li class="">
                    
    <a class="" href="../dev/maintainer-scripts/">Maintainer Scripts</a>
                </li>
                <li class="">
                    
    <a class="" href="../dev/nixpkgs-pin/">Nixpkgs Pin</a>
                </li>
                <li class="">
                    
    <a class="" href="../dev/removing-with-package-wrapper/">Removing withPackage wrapper</a>
                </li>
                <li class="">
                    
    <a class="" href="../dev/tests/">Test Suite</a>
                </li>
                <li class="">
                    
    <a class="" href="../dev/adding-new-ghc/">Adding a new GHC version</a>
                </li>
                <li class="">
                    
    <a class="" href="../dev/coverage/">Coverage</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../changelog/">ChangeLog</a>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Alternative Haskell Infrastructure for Nixpkgs</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Motivation</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/input-output-hk/haskell.nix/edit/master/docs/motivation.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="motivation">Motivation<a class="headerlink" href="#motivation" title="Permanent link">&para;</a></h1>
<p>Why do we need another Haskell infrastructure for Nix?</p>
<p>Doesn't nixpkgs
provide a sufficiently good Haskell infrastructure already?</p>
<p>Problems with
the nixpkgs haskell infrastructure are covered in the following sections:</p>
<h2 id="cross-compilation">Cross compilation<a class="headerlink" href="#cross-compilation" title="Permanent link">&para;</a></h2>
<p><code>nixpkgs</code> has quite good support for cross compilation, however the
Haskell infrastructure suffers from the fact that it heavily relies on
the <code>cabal2nix</code> tool.  <code>cabal2nix</code> (as well as tools that depend on it
like <code>stack2nix</code>) flattens the <code>.cabal</code> file at conversion time to a
given os/arch/flags configuration.  Thus to make cross compilation
work with <code>cabal2nix</code> you will have to generate a separate <code>nix</code>
expression for each configuration.  This becomes a major maintenance
burden over time.  Therefore the tooling that translates cabal files
into nix-expressions for use with Haskell.nix retains the full
conditional tree from the cabal file and exposes it to <code>nix</code>.  In
addition it will also expose the <code>build-type</code> value, which allows us
to cache the <code>Setup.hs</code> for build-type simple and not have to rebuild
it every time.</p>
<h2 id="package-sets">Package sets<a class="headerlink" href="#package-sets" title="Permanent link">&para;</a></h2>
<p>We often rely on either package sets as provided by stackage or
computed by cabal.  <code>nixpkgs</code> provides its own curated package set
which might or might not work for the projects we work on.
<code>stack2nix</code> tries to solve this issue, here we go one step further and
provide the infrastructure to allow any form of package set.</p>
<h2 id="per-component-level-control">Per component level control<a class="headerlink" href="#per-component-level-control" title="Permanent link">&para;</a></h2>
<p>The Haskell builder in <code>nixpkgs</code> provides control over executables and
libraries, to build a specific executable only however is rather
tricky to do.  This also leads to the cyclic dependencies issue.</p>
<h2 id="cyclic-dependencies">Cyclic dependencies<a class="headerlink" href="#cyclic-dependencies" title="Permanent link">&para;</a></h2>
<p>The Haskell builder in <code>nixpkgs</code> exposes packages at the
package level. If packages mutually depend on each other through tests
and libraries, this leads to cyclic dependencies that nix can't resolve. By
exposing the components to nix as separate derivations this will only
occur if you have mutually dependent components.</p>
<h2 id="build-times">Build times<a class="headerlink" href="#build-times" title="Permanent link">&para;</a></h2>
<p>The Haskell builder in nixpkgs builds a package sequentially, first the
library then the executables and finally the tests.  It then executes
the tests before the package is considered done.  The upshot of this
is that packages are only considered done if the test-suites
passed.  The downside is that if you have to compile multiple packages
the likelihood of them failing is low, you have unnecessarily
serialized your build.  In a more aggressive setting libraries could
start building as early as their dependent libraries are built.  Of
course they will have to be invalidated later should the test-suites
of their dependencies fail, but this way we can make use of parallel
building.  In an ideal scenario this will reduce build times close to
the optimum.</p>
<h2 id="more-logic-in-nix">More logic in nix<a class="headerlink" href="#more-logic-in-nix" title="Permanent link">&para;</a></h2>
<p>The <code>cabal2nix</code> tool has a resolver that resolves system dependencies
and licenses to values in <code>nixpkgs</code>.  This logic ends up being a simple
dictionary lookup and therefore can be a simple nix expression. This also
offloads some of the work the cabal to nix translation tool needs to
do into nix, and as such if changes are necessary (or needed to be
performed ad hoc) there is no need to rebuild the conversion tool and
subsequently mark every derived expression as out of date.</p>
<h2 id="decoupling">Decoupling<a class="headerlink" href="#decoupling" title="Permanent link">&para;</a></h2>
<p>Finally, by treating Haskell.nix and nixpkgs as separate entities we
can decouple the Haskell packages and infrastructure from the nixpkgs
package set, and rely on it to provide us with system packages while
staying up to date with Haskell packages from hackage while retaining
a stable (or known to be good) nixpkgs revision.</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../architecture/" class="btn btn-neutral float-right" title="Architecture">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href=".." class="btn btn-neutral" title="Introduction"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/input-output-hk/haskell.nix/" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href=".." style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../architecture/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>

</body>
</html>
